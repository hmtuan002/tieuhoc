<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Bài tập</title>
    <!-- Nhúng Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Nhúng Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .subject-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .subject-card:hover {
            transform: scale(1.03);
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .exercise-item {
            border-left: 4px solid #0d6efd;
            margin-bottom: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="text-center">Quản lý Bài tập</h2>
                    </div>
                    <div class="card-body">
                        <!-- Màn hình chọn môn học -->
                        <div id="subjectScreen">
                            <h3 class="text-center mb-4">Chọn môn học</h3>
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('toan')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Toán</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('tieng_viet')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Tiếng Việt</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('tieng_anh')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Tiếng Anh</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('tin_hoc')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Tin học</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('cong_nghe')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Công nghệ</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('lich_su_dia_ly')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Lịch sử & Địa lý</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card subject-card" onclick="selectSubject('khoa_hoc')">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Khoa học</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Màn hình chọn chương -->
                        <div id="chapterScreen" class="hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 id="currentSubjectTitle" class="mb-0"></h3>
                                <button class="btn btn-secondary" onclick="backToSubjects()">Quay lại</button>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Danh sách chương</h5>
                                            <button class="btn btn-sm btn-primary" onclick="showAddChapterModal()">Thêm chương</button>
                                        </div>
                                        <div class="card-body chapter-list" id="chapterList">
                                            <!-- Danh sách chương sẽ được load ở đây -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Bài tập trong chương: <span id="currentChapterTitle"></span></h5>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-primary mb-3" onclick="showAddExerciseModal()">Thêm bài tập</button>
                                            <div id="exerciseList">
                                                <!-- Danh sách bài tập sẽ được load ở đây -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal thêm chương mới -->
    <div class="modal fade" id="addChapterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm chương mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="chapterName" class="form-label">Tên chương</label>
                        <input type="text" class="form-control" id="chapterName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="addNewChapter()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal thêm/sửa bài tập -->
    <div class="modal fade" id="exerciseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exerciseModalTitle">Thêm bài tập mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exerciseQuestion" class="form-label">Câu hỏi</label>
                        <textarea class="form-control" id="exerciseQuestion" rows="5"></textarea>
                    </div>
                    <input type="hidden" id="currentExerciseId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveExercise()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nhúng Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Cấu hình Firebase - THAY THẾ bằng cấu hình của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyCyhGASygL5BVBB-0pJJNwoyTZ61pAzP7c",
            authDomain: "tieuhoc-a7f57.firebaseapp.com",
            projectId: "tieuhoc-a7f57",
            storageBucket: "tieuhoc-a7f57.firebasestorage.app",
            messagingSenderId: "736631398515",
            appId: "1:736631398515:web:a41bbabeeb98c3df42ca06"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Biến toàn cục
        let currentSubject = '';
        let currentChapter = '';
        let currentChapterId = '';
        let currentExerciseId = '';

        // Hiển thị tên môn học
        const subjectNames = {
            'toan': 'Toán',
            'tieng_viet': 'Tiếng Việt',
            'tieng_anh': 'Tiếng Anh',
            'tin_hoc': 'Tin học',
            'cong_nghe': 'Công nghệ',
            'lich_su_dia_ly': 'Lịch sử & Địa lý',
            'khoa_hoc': 'Khoa học'
        };

        // Chọn môn học
        function selectSubject(subject) {
            currentSubject = subject;
            document.getElementById('currentSubjectTitle').textContent = subjectNames[subject];
            document.getElementById('subjectScreen').classList.add('hidden');
            document.getElementById('chapterScreen').classList.remove('hidden');
            loadChapters();
        }

        // Quay lại màn hình chọn môn
        function backToSubjects() {
            document.getElementById('subjectScreen').classList.remove('hidden');
            document.getElementById('chapterScreen').classList.add('hidden');
            currentSubject = '';
            currentChapter = '';
            currentChapterId = '';
        }

        // Hiển thị modal thêm chương
        function showAddChapterModal() {
            document.getElementById('chapterName').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addChapterModal'));
            modal.show();
        }

        // Thêm chương mới
        async function addNewChapter() {
            const chapterName = document.getElementById('chapterName').value.trim();
            if (!chapterName) {
                alert('Vui lòng nhập tên chương');
                return;
            }

            try {
                // Thêm chương vào Firestore
                await db.collection('subjects').doc(currentSubject).collection('chapters').add({
                    name: chapterName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Đóng modal và tải lại danh sách chương
                bootstrap.Modal.getInstance(document.getElementById('addChapterModal')).hide();
                loadChapters();
            } catch (error) {
                console.error('Lỗi khi thêm chương:', error);
                alert('Có lỗi xảy ra khi thêm chương');
            }
        }

        // Tải danh sách chương
        async function loadChapters() {
            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = '<div class="text-center py-3">Đang tải...</div>';

            try {
                const snapshot = await db.collection('subjects').doc(currentSubject).collection('chapters').orderBy('createdAt').get();
                
                if (snapshot.empty) {
                    chapterList.innerHTML = '<div class="text-center py-3">Chưa có chương nào</div>';
                    return;
                }

                chapterList.innerHTML = '';
                snapshot.forEach(doc => {
                    const chapter = doc.data();
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'card mb-2';
                    chapterItem.innerHTML = `
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <span>${chapter.name}</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectChapter('${doc.id}', '${chapter.name}')">Chọn</button>
                        </div>
                    `;
                    chapterList.appendChild(chapterItem);
                });
            } catch (error) {
                console.error('Lỗi khi tải chương:', error);
                chapterList.innerHTML = '<div class="text-center py-3 text-danger">Lỗi khi tải danh sách chương</div>';
            }
        }

        // Chọn chương
        function selectChapter(chapterId, chapterName) {
            currentChapterId = chapterId;
            currentChapter = chapterName;
            document.getElementById('currentChapterTitle').textContent = chapterName;
            loadExercises();
        }

        // Tải danh sách bài tập
        async function loadExercises() {
            const exerciseList = document.getElementById('exerciseList');
            exerciseList.innerHTML = '<div class="text-center py-3">Đang tải...</div>';

            try {
                const snapshot = await db.collection('subjects').doc(currentSubject)
                    .collection('chapters').doc(currentChapterId)
                    .collection('exercises').orderBy('createdAt').get();
                
                if (snapshot.empty) {
                    exerciseList.innerHTML = '<div class="text-center py-3">Chưa có bài tập nào</div>';
                    return;
                }

                exerciseList.innerHTML = '';
                snapshot.forEach(doc => {
                    const exercise = doc.data();
                    const exerciseItem = document.createElement('div');
                    exerciseItem.className = 'card exercise-item';
                    exerciseItem.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6>Câu hỏi:</h6>
                                    <p>${exercise.question}</p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editExercise('${doc.id}', '${exercise.question.replace(/'/g, "\\'")}')">Sửa</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteExercise('${doc.id}')">Xóa</button>
                                </div>
                            </div>
                        </div>
                    `;
                    exerciseList.appendChild(exerciseItem);
                });
            } catch (error) {
                console.error('Lỗi khi tải bài tập:', error);
                exerciseList.innerHTML = '<div class="text-center py-3 text-danger">Lỗi khi tải danh sách bài tập</div>';
            }
        }

        // Hiển thị modal thêm bài tập
        function showAddExerciseModal() {
            if (!currentChapterId) {
                alert('Vui lòng chọn một chương trước');
                return;
            }
            
            document.getElementById('exerciseModalTitle').textContent = 'Thêm bài tập mới';
            document.getElementById('exerciseQuestion').value = '';
            document.getElementById('currentExerciseId').value = '';
            const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
            modal.show();
        }

        // Hiển thị modal sửa bài tập
        function editExercise(exerciseId, question) {
            document.getElementById('exerciseModalTitle').textContent = 'Sửa bài tập';
            document.getElementById('exerciseQuestion').value = question;
            document.getElementById('currentExerciseId').value = exerciseId;
            const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
            modal.show();
        }

        // Lưu bài tập (thêm mới hoặc cập nhật)
        async function saveExercise() {
            const question = document.getElementById('exerciseQuestion').value.trim();
            const exerciseId = document.getElementById('currentExerciseId').value;
            
            if (!question) {
                alert('Vui lòng nhập câu hỏi');
                return;
            }

            try {
                if (exerciseId) {
                    // Cập nhật bài tập
                    await db.collection('subjects').doc(currentSubject)
                        .collection('chapters').doc(currentChapterId)
                        .collection('exercises').doc(exerciseId)
                        .update({
                            question: question,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } else {
                    // Thêm bài tập mới
                    await db.collection('subjects').doc(currentSubject)
                        .collection('chapters').doc(currentChapterId)
                        .collection('exercises').add({
                            question: question,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }
                
                // Đóng modal và tải lại danh sách bài tập
                bootstrap.Modal.getInstance(document.getElementById('exerciseModal')).hide();
                loadExercises();
            } catch (error) {
                console.error('Lỗi khi lưu bài tập:', error);
                alert('Có lỗi xảy ra khi lưu bài tập');
            }
        }

        // Xóa bài tập
        async function deleteExercise(exerciseId) {
            if (!confirm('Bạn có chắc chắn muốn xóa bài tập này?')) {
                return;
            }

            try {
                await db.collection('subjects').doc(currentSubject)
                    .collection('chapters').doc(currentChapterId)
                    .collection('exercises').doc(exerciseId)
                    .delete();
                
                loadExercises();
            } catch (error) {
                console.error('Lỗi khi xóa bài tập:', error);
                alert('Có lỗi xảy ra khi xóa bài tập');
            }
        }
    </script>
</body>
</html>
