<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot h·ªçc t·∫≠p tr∆∞·ªùng TH Th∆∞·ª£ng ·∫§m</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #e0f7fa;
            color: #333;
            overflow: hidden;
        }

        #home-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 20px;
            text-align: center;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
        }

        #home-menu h1 {
            color: #26a69a;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .subject-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            width: 80%;
            max-width: 900px;
        }

        .subject-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .subject-button i {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subject-button:hover {
            background-color: #45a049;
            transform: translateY(-3px);
        }

        #chatbot-container {
            display: none;
            flex-grow: 1;
            flex-direction: row;
            overflow: hidden;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
        }

        #sidebar {
            width: 200px;
            background-color: #f0f4c3;
            padding: 15px;
            border-right: 1px solid #dce775;
            display: flex;
            flex-direction: column;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.05);
        }

        #sidebar h3 {
            color: #689f38;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .sidebar-button {
            background-color: #c5e1a5;
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 12px 10px;
            margin-bottom: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: left;
            display: flex;
            align-items: center;
        }

        .sidebar-button i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .sidebar-button.active, .sidebar-button:hover {
            background-color: #8bc34a;
            color: white;
            transform: translateX(3px);
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #khung-tro-chuyen {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #b2ebf2;
            background-color: #ffffff;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .tin-nhan {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 75%;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .tin-nhan-nguoi-dung {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 5px;
        }

        .tin-nhan-bot {
            background-color: #e3f2fd;
            color: #212121;
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        #khu-vuc-nhap {
            display: flex;
            padding: 15px;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
            align-items: center;
        }

        #o-nhap-tin-nhan {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #c5e1a5;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        #o-nhap-tin-nhan:focus {
            border-color: #8bc34a;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.2);
        }

        #nut-gui {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-left: 15px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }

        #nut-gui:hover {
            background-color: #45a049;
        }

        #nut-gui:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            #home-menu {
                margin: 10px;
                padding: 15px;
            }

            #home-menu h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .subject-buttons {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 15px;
                width: 95%;
            }

            .subject-button {
                padding: 15px;
                font-size: 1em;
            }

            .subject-button i {
                font-size: 2em;
                margin-bottom: 8px;
            }

            #chatbot-container {
                flex-direction: column;
                margin: 10px;
                border-radius: 8px;
            }

            #sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #dce775;
                padding: 10px;
                box-shadow: inset 0 -2px 5px rgba(0,0,0,0.05);
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            #sidebar h3 {
                display: none;
            }

            .sidebar-button {
                flex-shrink: 0;
                width: auto;
                margin-bottom: 0;
                margin-right: 10px;
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .sidebar-button i {
                font-size: 1em;
                margin-right: 5px;
            }

            .chat-area {
                min-height: 0;
            }

            #khung-tro-chuyen {
                padding: 10px;
            }

            .tin-nhan {
                max-width: 85%;
                padding: 8px 12px;
                font-size: 0.9em;
            }

            #khu-vuc-nhap {
                padding: 10px;
            }

            #o-nhap-tin-nhan {
                padding: 10px 15px;
                font-size: 14px;
            }

            #nut-gui {
                width: 40px;
                height: 40px;
                font-size: 20px;
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="home-menu">
        <h1>Chatbot h·ªçc t·∫≠p tr∆∞·ªùng TH Th∆∞·ª£ng ·∫§m</h1>
        <div class="subject-buttons">
            <button class="subject-button" data-subject="toan">
                <i class="fas fa-calculator"></i>
                To√°n
            </button>
            <button class="subject-button" data-subject="tieng-viet">
                <i class="fas fa-book-open"></i>
                Ti·∫øng Vi·ªát
            </button>
            <button class="subject-button" data-subject="tieng-anh">
                <i class="fas fa-globe"></i>
                Ti·∫øng Anh
            </button>
            <button class="subject-button" data-subject="tin-hoc">
                <i class="fas fa-laptop-code"></i>
                Tin H·ªçc
            </button>
            <button class="subject-button" data-subject="cong-nghe">
                <i class="fas fa-tools"></i>
                C√¥ng Ngh·ªá
            </button>
            <button class="subject-button" data-subject="lich-su-dia-ly">
                <i class="fas fa-map-marked-alt"></i>
                L·ªãch S·ª≠ & ƒê·ªãa L√Ω
            </button>
            <button class="subject-button" data-subject="khoa-hoc">
                <i class="fas fa-flask"></i>
                Khoa H·ªçc
            </button>
        </div>
    </div>

    <div id="chatbot-container">
        <div id="sidebar">
            <h3>M√¥n h·ªçc</h3>
            <button class="sidebar-button" data-subject="toan">
                <i class="fas fa-calculator"></i>
                To√°n
            </button>
            <button class="sidebar-button" data-subject="tieng-viet">
                <i class="fas fa-book-open"></i>
                Ti·∫øng Vi·ªát
            </button>
            <button class="sidebar-button" data-subject="tieng-anh">
                <i class="fas fa-globe"></i>
                Ti·∫øng Anh
            </button>
            <button class="sidebar-button" data-subject="tin-hoc">
                <i class="fas fa-laptop-code"></i>
                Tin H·ªçc
            </button>
            <button class="sidebar-button" data-subject="cong-nghe">
                <i class="fas fa-tools"></i>
                C√¥ng Ngh·ªá
            </button>
            <button class="sidebar-button" data-subject="lich-su-dia-ly">
                <i class="fas fa-map-marked-alt"></i>
                L·ªãch S·ª≠ & ƒê·ªãa L√Ω
            </button>
            <button class="sidebar-button" data-subject="khoa-hoc">
                <i class="fas fa-flask"></i>
                Khoa H·ªçc
            </button>
        </div>
        <div class="chat-area">
            <div id="khung-tro-chuyen">
            </div>
            <div id="khu-vuc-nhap">
                <input type="text" id="o-nhap-tin-nhan" placeholder="H·ªèi t√¥i ƒëi·ªÅu g√¨ ƒë√≥...">
                <button id="nut-gui">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Thay th·∫ø "YOUR_API_KEY" b·∫±ng kh√≥a API th·ª±c t·∫ø c·ªßa b·∫°n
        const KHOA_API = "AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM"; 
        const moHinhAI = new GoogleGenerativeAI(KHOA_API);
        const moHinh = moHinhAI.getGenerativeModel({ model: "gemini-2.0-flash-thinking-exp-01-21" });

        const homeMenu = document.getElementById('home-menu');
        const chatbotContainer = document.getElementById('chatbot-container');
        const khungTroChuyen = document.getElementById('khung-tro-chuyen');
        const oNhapTinNhan = document.getElementById('o-nhap-tin-nhan');
        const nutGui = document.getElementById('nut-gui');
        const subjectButtons = document.querySelectorAll('.subject-button');
        const sidebarButtons = document.querySelectorAll('.sidebar-button');

        let currentSubject = '';
        let homeworkData = {}; // ƒê·ªëi t∆∞·ª£ng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu b√†i t·∫≠p t·ª´ baitap.txt
// Th√™m v√†o ph·∫ßn khai b√°o bi·∫øn
let multipleChoiceData = {}; // ƒê·ªëi t∆∞·ª£ng l∆∞u tr·ªØ d·ªØ li·ªáu tr·∫Øc nghi·ªám
let currentQuiz = null; // L∆∞u tr·ªØ b√†i tr·∫Øc nghi·ªám hi·ªán t·∫°i
let quizSubject = ''; // M√¥n h·ªçc c·ªßa b√†i tr·∫Øc nghi·ªám hi·ªán t·∫°i
        // ƒê·ªãnh nghƒ©a c√°c m√¥n h·ªçc v√† b·ªô l·ªçc
        const subjectFilters = {
            "toan": {
                name: "To√°n",
                excludeKeywords: ["ƒë·∫°i s·ªë tuy·∫øn t√≠nh", "gi·∫£i t√≠ch", "l∆∞·ª£ng t·ª≠", "ph√¢n t√≠ch chuy√™n s√¢u"],
                homeworkExamples: [] // S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª´ baitap.txt
            },
            "tieng-viet": {
                name: "Ti·∫øng Vi·ªát",
                excludeKeywords: ["nghi√™n c·ª©u vƒÉn h·ªçc", "ph√¢n t√≠ch chuy√™n s√¢u", "tri·∫øt h·ªçc", "ng·ªØ ph√°p n√¢ng cao", "ph·∫£n bi·ªán vƒÉn h·ªçc"],
                homeworkExamples: []
            },
            "tieng-anh": {
                name: "Ti·∫øng Anh",
                excludeKeywords: ["advanced grammar", "literary analysis", "linguistics", "academic writing", "syntax"],
                homeworkExamples: []
            },
            "tin-hoc": {
                name: "Tin H·ªçc",
                excludeKeywords: ["l·∫≠p tr√¨nh", "tr√≠ tu·ªá nh√¢n t·∫°o", "m√°y h·ªçc", "c√¥ng ngh·ªá th√¥ng tin chuy√™n s√¢u", "thu·∫≠t to√°n ph·ª©c t·∫°p", "m·∫°ng m√°y t√≠nh"],
                homeworkExamples: []
            },
            "cong-nghe": {
                name: "C√¥ng Ngh·ªá",
                excludeKeywords: ["k·ªπ thu·∫≠t", "c√¥ng ngh·ªá cao", "t·ª± ƒë·ªông h√≥a", "robotics", "thi·∫øt k·∫ø m·∫°ch", "v·∫≠t li·ªáu m·ªõi"],
                homeworkExamples: []
            },
            "lich-su-dia-ly": {
                name: "L·ªãch S·ª≠ & ƒê·ªãa L√Ω",
                excludeKeywords: ["nghi√™n c·ª©u s·ª≠ h·ªçc", "ph√¢n t√≠ch ƒë·ªãa ch√≠nh tr·ªã", "kinh t·∫ø h·ªçc", "x√£ h·ªôi h·ªçc", "di·ªÖn bi·∫øn ph·ª©c t·∫°p", "l√Ω thuy·∫øt ƒë·ªãa l√Ω"],
                homeworkExamples: []
            },
            "khoa-hoc": {
                name: "Khoa H·ªçc",
                excludeKeywords: ["v·∫≠t l√Ω l∆∞·ª£ng t·ª≠", "h√≥a h·ªçc h·ªØu c∆°", "sinh h·ªçc ph√¢n t·ª≠", "thi√™n vƒÉn h·ªçc", "di truy·ªÅn h·ªçc", "nghi√™n c·ª©u khoa h·ªçc chuy√™n s√¢u"],
                homeworkExamples: []
            }
        };

        const generalExcludeKeywords = [
            "ƒë·∫°i h·ªçc", "cao h·ªçc", "nghi√™n c·ª©u", "ph√¢n t√≠ch chuy√™n s√¢u", "v·∫≠t l√Ω h·∫°t nh√¢n", "tri·∫øt h·ªçc",
            "kinh t·∫ø vƒ© m√¥", "ch√≠nh tr·ªã qu·ªëc t·∫ø", "ch·ª©ng minh", "ph·∫£n bi·ªán", "t√¥n gi√°o", "ƒë·ª©c tin"
        ];
        // C√°c c·ª•m t·ª´ ng∆∞·ªùi d√πng c√≥ th·ªÉ d√πng ƒë·ªÉ y√™u c·∫ßu b√†i t·∫≠p
        const homeworkRequestPhrases = /(cho (t√¥i|em) b√†i t·∫≠p|xin b√†i t·∫≠p|g·ª£i √Ω b√†i t·∫≠p|b√†i t·∫≠p v·ªÅ)/;
function getRandomItems(array, count) {
    const shuffled = [...array].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, Math.min(count, array.length));
}
async function loadMultipleChoiceData() {
    try {
        const response = await fetch('tracnghiem.txt');
        if (!response.ok) {
            throw new Error(`L·ªói HTTP! status: ${response.status}`);
        }
        const text = await response.text();
        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

        let currentSection = '';
        let currentQuestion = null;
        
        for (const line of lines) {
            if (line.startsWith('#')) {
                currentSection = line.substring(1);
                multipleChoiceData[currentSection] = [];
            } else if (line.match(/^\d+\./)) {
                // B·∫Øt ƒë·∫ßu c√¢u h·ªèi m·ªõi
                if (currentQuestion) {
                    multipleChoiceData[currentSection].push(currentQuestion);
                }
                currentQuestion = {
                    question: line.substring(line.indexOf('.') + 1).trim(),
                    options: [],
                    answer: ''
                };
            } else if (line.match(/^[A-D]\)/)) {
                // Th√™m l·ª±a ch·ªçn
                currentQuestion.options.push(line.trim());
            } else if (line.startsWith('ƒê√°p √°n:')) {
                // Th√™m ƒë√°p √°n
                currentQuestion.answer = line.substring('ƒê√°p √°n:'.length).trim();
            }
        }
        // Th√™m c√¢u h·ªèi cu·ªëi c√πng
        if (currentQuestion && currentSection) {
            multipleChoiceData[currentSection].push(currentQuestion);
        }
        
        console.log("D·ªØ li·ªáu tr·∫Øc nghi·ªám ƒë√£ t·∫£i:", multipleChoiceData);
    } catch (error) {
        console.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu tr·∫Øc nghi·ªám:", error);
        multipleChoiceData = {};
    }
}
        // H√†m ƒë·ªÉ t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu b√†i t·∫≠p t·ª´ baitap.txt
        async function loadHomeworkData() {
            try {
                const response = await fetch('baitap.txt');
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP! status: ${response.status}`);
                }
                const text = await response.text();
                // T√°ch c√°c d√≤ng, lo·∫°i b·ªè kho·∫£ng tr·∫Øng v√† d√≤ng tr·ªëng
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                let currentSection = '';
                for (const line of lines) {
                    if (line.startsWith('#')) {
                        currentSection = line.substring(1); // L·∫•y kh√≥a m√¥n h·ªçc (vd: "toan")
                        homeworkData[currentSection] = []; // Kh·ªüi t·∫°o m·∫£ng r·ªóng cho m√¥n h·ªçc n√†y
                    } else if (currentSection && homeworkData[currentSection]) {
                        homeworkData[currentSection].push(line); // Th√™m b√†i t·∫≠p v√†o m√¥n h·ªçc hi·ªán t·∫°i
                    }
                }
                // ƒêi·ªÅn d·ªØ li·ªáu b√†i t·∫≠p ƒë√£ t·∫£i v√†o subjectFilters
                for (const subjectKey in homeworkData) {
                    if (subjectFilters[subjectKey]) {
                        subjectFilters[subjectKey].homeworkExamples = homeworkData[subjectKey];
                    }
                }
                console.log("D·ªØ li·ªáu b√†i t·∫≠p ƒë√£ t·∫£i:", homeworkData);
            } catch (error) {
                console.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i t·∫≠p:", error);
                // ƒê·∫∑t l·∫°i homeworkExamples th√†nh r·ªóng n·∫øu c√≥ l·ªói
                for (const key in subjectFilters) {
                    subjectFilters[key].homeworkExamples = [];
                }
            }
        }

        // T·∫£i d·ªØ li·ªáu b√†i t·∫≠p khi script b·∫Øt ƒë·∫ßu
        loadHomeworkData();
loadMultipleChoiceData();

        // G√°n s·ª± ki·ªán cho c√°c n√∫t ch·ªçn m√¥n h·ªçc ·ªü trang ch·ªß
        subjectButtons.forEach(button => {
            button.addEventListener('click', () => selectSubject(button.dataset.subject));
        });

        // G√°n s·ª± ki·ªán cho c√°c n√∫t ch·ªçn m√¥n h·ªçc ·ªü thanh sidebar
        sidebarButtons.forEach(button => {
            button.addEventListener('click', () => selectSubject(button.dataset.subject));
        });

        // G√°n s·ª± ki·ªán cho n√∫t g·ª≠i tin nh·∫Øn
        nutGui.addEventListener('click', guiTinNhan);
        // G√°n s·ª± ki·ªán cho ph√≠m Enter trong √¥ nh·∫≠p tin nh·∫Øn
        oNhapTinNhan.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                guiTinNhan();
            }
        });

        /**
         * Chuy·ªÉn ƒë·ªïi gi·ªØa menu ch·ªçn m√¥n h·ªçc v√† giao di·ªán chatbot.
         * ƒê·∫∑t m√¥n h·ªçc hi·ªán t·∫°i v√† hi·ªÉn th·ªã l·ªùi ch√†o.
         * @param {string} subject - Kh√≥a c·ªßa m√¥n h·ªçc ƒë∆∞·ª£c ch·ªçn (vd: "toan").
         */
        function selectSubject(subject) {
            currentSubject = subject;
            homeMenu.style.display = 'none';
            chatbotContainer.style.display = 'flex';
            khungTroChuyen.innerHTML = ''; // X√≥a tin nh·∫Øn c≈© khi ƒë·ªïi m√¥n
            themTinNhanVaoGiaoDien("bot", `Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi m√¥n ${subjectFilters[subject].name}! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?`);

            // ƒê·∫∑t tr·∫°ng th√°i 'active' cho n√∫t sidebar t∆∞∆°ng ·ª©ng
            sidebarButtons.forEach(button => {
                if (button.dataset.subject === subject) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        /**
         * Th√™m tin nh·∫Øn v√†o giao di·ªán tr√≤ chuy·ªán.
         * @param {string} nguoiGui - Ng∆∞·ªùi g·ª≠i tin nh·∫Øn ("nguoi-dung" ho·∫∑c "bot").
         * @param {string} vanBan - N·ªôi dung tin nh·∫Øn.
         */
        function themTinNhanVaoGiaoDien(nguoiGui, vanBan) {
            const divTinNhan = document.createElement('div');
            divTinNhan.classList.add('tin-nhan', `tin-nhan-${nguoiGui}`);

            // Chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng markdown c∆° b·∫£n (in ƒë·∫≠m, xu·ªëng d√≤ng)
            let formattedText = vanBan.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\n/g, '<br>');

            divTinNhan.innerHTML = formattedText;
            khungTroChuyen.appendChild(divTinNhan);
            // Cu·ªôn xu·ªëng cu·ªëi khung tr√≤ chuy·ªán
            khungTroChuyen.scrollTop = khungTroChuyen.scrollHeight;
        }

      // H√†m b·ªï sung: Ch·ªçn ng·∫´u nhi√™n 10 c√¢u t·ª´ danh s√°ch
function getRandomQuestions(questions, count) {
    const shuffled = [...questions].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
}

// S·ª≠a h√†m startMultipleChoiceQuiz
function startMultipleChoiceQuiz(subject) {
    if (!multipleChoiceData[subject] || multipleChoiceData[subject].length === 0) {
        themTinNhanVaoGiaoDien("bot", `Hi·ªán kh√¥ng c√≥ b√†i t·∫≠p tr·∫Øc nghi·ªám n√†o cho m√¥n ${subjectFilters[subject].name}.`);
        return;
    }

    // L·∫•y t·∫•t c·∫£ c√¢u h·ªèi c·ªßa m√¥n h·ªçc
    const allQuestions = multipleChoiceData[subject];
    
    // N·∫øu m√¥n To√°n c√≥ >10 c√¢u ‚Üí ch·ªçn ng·∫´u nhi√™n 10 c√¢u
    const selectedQuestions = (subject === 'toan' && allQuestions.length > 10) 
        ? getRandomQuestions(allQuestions, 10) 
        : allQuestions;

    quizSubject = subject;
    currentQuiz = {
        questions: selectedQuestions,
        currentQuestionIndex: 0,
        userAnswers: [],
        score: 0
    };
    
    showNextQuestion();
}

function showNextQuestion() {
    if (currentQuiz.currentQuestionIndex >= currentQuiz.questions.length) {
        // K·∫øt th√∫c b√†i tr·∫Øc nghi·ªám
        finishQuiz();
        return;
    }
    
    const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
    let message = `C√¢u ${currentQuiz.currentQuestionIndex + 1}: ${question.question}\n`;
    question.options.forEach(option => {
        message += `${option}\n`;
    });
    message += "\nH√£y nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n (v√≠ d·ª•: A, B, C ho·∫∑c D)";
    
    themTinNhanVaoGiaoDien("bot", message);
}

function finishQuiz() {
    const totalQuestions = currentQuiz.questions.length;
    const score = (currentQuiz.score / totalQuestions) * 10; // T√≠nh ƒëi·ªÉm tr√™n 10
    
    let resultMessage = `K·∫øt qu·∫£ b√†i tr·∫Øc nghi·ªám m√¥n ${subjectFilters[quizSubject].name}:\n`;
    resultMessage += `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${currentQuiz.score}/${totalQuestions} c√¢u\n`;
    resultMessage += `ƒêi·ªÉm c·ªßa b·∫°n: ${score.toFixed(1)}/10\n\n`;
    
    // Hi·ªÉn th·ªã c√°c c√¢u sai v√† ƒë√°p √°n ƒë√∫ng
    for (let i = 0; i < totalQuestions; i++) {
        const userAnswer = currentQuiz.userAnswers[i];
        const correctAnswer = currentQuiz.questions[i].answer;
        
        if (userAnswer !== correctAnswer) {
            resultMessage += `C√¢u ${i + 1}: B·∫°n ch·ªçn ${userAnswer || '(b·ªè tr·ªëng)'}, ƒë√°p √°n ƒë√∫ng l√† ${correctAnswer}\n`;
        }
    }
    
    themTinNhanVaoGiaoDien("bot", resultMessage);
    currentQuiz = null;
    quizSubject = '';
}
function handleQuizAnswer(answer) {
    const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
    const userAnswer = answer.trim().toUpperCase();
    
    // Ki·ªÉm tra ƒë√°p √°n
    if (['A', 'B', 'C', 'D'].includes(userAnswer)) {
        currentQuiz.userAnswers.push(userAnswer);
        
        if (userAnswer === currentQuestion.answer) {
            currentQuiz.score++;
            themTinNhanVaoGiaoDien("bot", "Ch√≠nh x√°c! üéâ");
        } else {
            let explanation = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${currentQuestion.answer}.\n`;
            explanation += `Gi·∫£i th√≠ch v√¨ sao ƒë√°p √°n ƒë√∫ng l√†: ${currentQuestion.explanation || 'C√¢u n√†y c·∫ßn √°p d·ª•ng ki·∫øn th·ª©c c∆° b·∫£n trong ch∆∞∆°ng tr√¨nh ti·ªÉu h·ªçc'}`;
            themTinNhanVaoGiaoDien("bot", explanation);
        }
        
        // Chuy·ªÉn sang c√¢u h·ªèi ti·∫øp theo
        currentQuiz.currentQuestionIndex++;
        setTimeout(() => showNextQuestion(), 1500);
    } else {
        themTinNhanVaoGiaoDien("bot", "Vui l√≤ng nh·∫≠p ƒë√°p √°n l√† A, B, C ho·∫∑c D (v√≠ d·ª•: A, B, ...)");
    }
}

        async function guiTinNhan() {
    const tinNhanNguoiDung = oNhapTinNhan.value.trim();
    if (!tinNhanNguoiDung) return;

    themTinNhanVaoGiaoDien("nguoi-dung", tinNhanNguoiDung);
    oNhapTinNhan.value = '';

    // X·ª≠ l√Ω n·∫øu ƒëang trong ch·∫ø ƒë·ªô tr·∫Øc nghi·ªám
    if (currentQuiz) {
        handleQuizAnswer(tinNhanNguoiDung);
        return;
    }

    // Ki·ªÉm tra y√™u c·∫ßu b√†i t·∫≠p tr·∫Øc nghi·ªám
    const isAskingForMultipleChoice = /(b√†i t·∫≠p tr·∫Øc nghi·ªám|tr·∫Øc nghi·ªám|b√†i t·∫≠p TN)/i.test(tinNhanNguoiDung);
    if (isAskingForMultipleChoice) {
        startMultipleChoiceQuiz(currentSubject);
        return;
    }

            // X·ª≠ l√Ω l·ªùi ch√†o ƒë∆°n gi·∫£n
            const loiChao = ["ch√†o", "hello", "hi"];
            if (loiChao.some(chao => tinNhanNguoiDung.toLowerCase().includes(chao))) {
                themTinNhanVaoGiaoDien("bot", `Ch√†o b·∫°n! T√¥i l√† m·ªôt chatbot AI ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi c·∫•p ti·ªÉu h·ªçc cho m√¥n ${subjectFilters[currentSubject].name}. B·∫°n c√≥ c√¢u h·ªèi g√¨ kh√¥ng?`);
                return;
            }

            // --- LOGIC X·ª¨ L√ù Y√äU C·∫¶U B√ÄI T·∫¨P T·ª™ baitap.txt ---
            const isAskingForHomework = homeworkRequestPhrases.test(tinNhanNguoiDung.toLowerCase());

           if (isAskingForHomework) {
    if (currentSubject && subjectFilters[currentSubject] && subjectFilters[currentSubject].homeworkExamples.length > 0) {
        // L·∫•y ng·∫´u nhi√™n 3 c√¢u t·ª´ danh s√°ch b√†i t·∫≠p
        const randomExamples = getRandomItems(subjectFilters[currentSubject].homeworkExamples, 3);
        const examples = randomExamples.map(e => `- ${e}`).join('\n');
        
        themTinNhanVaoGiaoDien("bot", 
            `D∆∞·ªõi ƒë√¢y l√† 3 b√†i t·∫≠p ng·∫´u nhi√™n m√¥n **${subjectFilters[currentSubject].name}** ƒë·ªÉ em th·ª≠ s·ª©c:\n${examples}\n\n` +
            `Em h√£y l√†m th·ª≠ v√† h·ªèi th·∫ßy n·∫øu c·∫ßn h∆∞·ªõng d·∫´n nh√©!`
        );
    } else {
        themTinNhanVaoGiaoDien("bot", "Hi·ªán ch∆∞a c√≥ b√†i t·∫≠p cho m√¥n n√†y. Em c√≥ th·ªÉ h·ªèi th·∫ßy v·ªÅ c√°ch l√†m m·ªôt d·∫°ng b√†i c·ª• th·ªÉ nh√©!");
    }
    return;
}

            // Ki·ªÉm tra xem c√¢u h·ªèi c√≥ ph√π h·ª£p c·∫•p ti·ªÉu h·ªçc kh√¥ng
            if (!laCauHoiTieuHoc(tinNhanNguoiDung)) {
                themTinNhanVaoGiaoDien("bot", "Xin l·ªói, t√¥i ch·ªâ c√≥ th·ªÉ gi√∫p b·∫°n v·ªõi c√°c c√¢u h·ªèi v√† b√†i t·∫≠p ·ªü c·∫•p ƒë·ªô ti·ªÉu h·ªçc. Vui l√≤ng h·ªèi nh·ªØng c√¢u h·ªèi ph√π h·ª£p h∆°n nh√©.");
                return;
            }

            // G·ª≠i c√¢u h·ªèi ƒë·∫øn m√¥ h√¨nh AI n·∫øu kh√¥ng ph·∫£i l√† y√™u c·∫ßu b√†i t·∫≠p t·ª´ file v√† ph√π h·ª£p c·∫•p ti·ªÉu h·ªçc
            try {
                const loiNhac = `B·∫°n l√† m·ªôt gi√°o vi√™n AI th√¢n thi·ªán v√† h·ªØu √≠ch (l∆∞u √Ω x∆∞ng h√¥ v·ªõi ng∆∞·ªùi d√πng l√† th·∫ßy - em), chuy√™n gi·∫£i ƒë√°p c√°c c√¢u h·ªèi v√† g·ª£i √Ω c√°ch l√†m b√†i t·∫≠p cho h·ªçc sinh ti·ªÉu h·ªçc trong m√¥n ${subjectFilters[currentSubject].name}. H√£y tr·∫£ l·ªùi m·ªôt c√°ch ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu, v√† ch·ªâ t·∫≠p trung v√†o ki·∫øn th·ª©c c·∫•p ti·ªÉu h·ªçc. Tuy·ªát ƒë·ªëi kh√¥ng gi·∫£i b√†i t·∫≠p c·ª• th·ªÉ, ch·ªâ g·ª£i √Ω ph∆∞∆°ng ph√°p ho·∫∑c h∆∞·ªõng d·∫´n. N·∫øu c√¢u h·ªèi kh√¥ng ph√π h·ª£p c·∫•p ti·ªÉu h·ªçc ho·∫∑c y√™u c·∫ßu gi·∫£i b√†i t·∫≠p chi ti·∫øt, h√£y t·ª´ ch·ªëi m·ªôt c√°ch nh·∫π nh√†ng v√† l·ªãch s·ª±. N·∫øu ng∆∞·ªùi d√πng xin b√†i t·∫≠p ƒë·ªÉ l√†m th√¨ c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c.
                \n\nC√¢u h·ªèi: ${tinNhanNguoiDung}`;

                const ketQua = await moHinh.generateContent(loiNhac);
                const phanHoi = await ketQua.response;
                const traLoiBot = phanHoi.text();
                themTinNhanVaoGiaoDien("bot", traLoiBot);

            } catch (loi) {
                console.error("L·ªói khi g·ªçi API Gemini: ", loi);
                themTinNhanVaoGiaoDien("bot", "R·∫•t ti·∫øc, c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau nh√©!");
            }
        }

        /**
         * Ki·ªÉm tra xem c√¢u h·ªèi c√≥ ph√π h·ª£p v·ªõi c·∫•p ƒë·ªô ti·ªÉu h·ªçc hay kh√¥ng.
         * @param {string} cauHoi - C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng.
         * @returns {boolean} - True n·∫øu ph√π h·ª£p, False n·∫øu kh√¥ng.
         */
        function laCauHoiTieuHoc(cauHoi) {
            const cauHoiThuong = cauHoi.toLowerCase();

            // Ki·ªÉm tra c√°c t·ª´ kh√≥a lo·∫°i tr·ª´ chung
            const laKhongTieuHocChung = generalExcludeKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
            if (laKhongTieuHocChung) return false;

            // Ki·ªÉm tra c√°c t·ª´ kh√≥a lo·∫°i tr·ª´ theo m√¥n h·ªçc c·ª• th·ªÉ
            if (currentSubject && subjectFilters[currentSubject]) {
                const subjectSpecificKeywords = subjectFilters[currentSubject].excludeKeywords;
                const laKhongTieuHocMonHoc = subjectSpecificKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
                if (laKhongTieuHocMonHoc) return false;
            }

            return true;
        }

        // H√†m n√†y kh√¥ng c√≤n quy·∫øt ƒë·ªãnh h√†nh vi ch√≠nh m√† ch·ªâ h·ªó tr·ª£ regex cho homeworkRequestPhrases
        function laYeuCauGiaiBaiTap(cauHoi) {
            const cauHoiThuong = cauHoi.toLowerCase();
            return homeworkRequestPhrases.test(cauHoiThuong);
        }
    </script>
</body>
</html>
