<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot học tập trường TH Thượng Ấm</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #e0f7fa;
            color: #333;
            overflow: hidden;
        }

        /* Grade Selection Screen */
        #gradeScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 20px;
            text-align: center;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
        }

        #gradeScreen h1 {
            color: #26a69a;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .grade-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            width: 80%;
            max-width: 900px;
        }

        .grade-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .grade-button i {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .grade-button:hover {
            background-color: #45a049;
            transform: translateY(-3px);
        }

        /* Subject Selection Screen */
        #subjectScreen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 20px;
            text-align: center;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
        }

        #subjectScreen h1 {
            color: #26a69a;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .subject-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            width: 80%;
            max-width: 900px;
        }

        .subject-button {
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .subject-button i {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subject-button:hover {
            background-color: #1976D2;
            transform: translateY(-3px);
        }

        /* Chapter Selection Screen */
        #chapterScreen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
        }

        .chapter-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .chapter-card {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #4CAF50;
        }

        .chapter-card:hover {
            background-color: #e8f5e9;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .chapter-card h3 {
            margin-top: 0;
            color: #2E7D32;
        }

        /* Chatbot Screen */
        #chatbot-container {
            display: none;
            flex-grow: 1;
            flex-direction: column;
            overflow: hidden;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #khung-tro-chuyen {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #b2ebf2;
            background-color: #ffffff;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .tin-nhan {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 75%;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .tin-nhan-nguoi-dung {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 5px;
        }

        .tin-nhan-bot {
            background-color: #e3f2fd;
            color: #212121;
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        #khu-vuc-nhap {
            display: flex;
            padding: 15px;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
            align-items: center;
        }

        #o-nhap-tin-nhan-container {
            position: relative;
            flex-grow: 1;
            min-height: 48px;
        }

        #o-nhap-tin-nhan {
            width: 100%;
            background: transparent;
            position: relative;
            z-index: 2;
            color: transparent;
            caret-color: #333;
            padding: 12px 18px;
            border: 1px solid #c5e1a5;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s ease;
            min-height: 48px;
            resize: none;
            overflow: hidden;
        }

        #o-nhap-tin-nhan:focus {
            border-color: #8bc34a;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.2);
        }

        #o-nhap-tin-nhan-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 48px;
            padding: 12px 18px;
            pointer-events: none;
            z-index: 1;
            white-space: pre-wrap;
            overflow: hidden;
            color: #333;
            border: 1px solid transparent;
            border-radius: 25px;
            font-size: 16px;
            line-height: 1.4;
        }

        #nut-gui {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-left: 15px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }

        #nut-gui:hover {
            background-color: #45a049;
        }

        #nut-gui:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Navigation buttons */
        .back-button {
            margin-bottom: 20px;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* Breadcrumb */
        .breadcrumb {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .breadcrumb-item a {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        /* Style cho phân số */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        
        .fraction span {
            display: block;
        }
        
        .fraction .numerator {
            border-bottom: 1px solid #000;
            padding: 0 3px;
        }
        
        .fraction .denominator {
            padding: 0 3px;
        }

        /* Style cho hỗn số */
        .mixed-number {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        
        .mixed-number .whole-part {
            padding-right: 2px;
        }
        
        .mixed-number .fraction {
            display: inline-block;
        }

        @media (max-width: 768px) {
            .grade-buttons, .subject-buttons {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 15px;
                width: 95%;
            }

            .grade-button, .subject-button {
                padding: 15px;
                font-size: 1em;
            }

            .grade-button i, .subject-button i {
                font-size: 2em;
                margin-bottom: 8px;
            }

            #chatbot-container {
                margin: 10px;
                border-radius: 8px;
            }

            .chat-area {
                min-height: 0;
            }

            #khung-tro-chuyen {
                padding: 10px;
            }

            .tin-nhan {
                max-width: 85%;
                padding: 8px 12px;
                font-size: 0.9em;
            }

            #khu-vuc-nhap {
                padding: 10px;
            }

            #o-nhap-tin-nhan, #o-nhap-tin-nhan-preview {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 40px;
            }

            #nut-gui {
                width: 40px;
                height: 40px;
                font-size: 20px;
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Grade Selection Screen -->
    <div id="gradeScreen">
        <h1>Chatbot học tập trường TH Thượng Ấm</h1>
        <h3>Chọn lớp của em</h3>
        <div class="grade-buttons">
            <button class="grade-button" data-grade="lop1">
                <i class="fas fa-user-graduate"></i>
                Lớp 1
            </button>
            <button class="grade-button" data-grade="lop2">
                <i class="fas fa-user-graduate"></i>
                Lớp 2
            </button>
            <button class="grade-button" data-grade="lop3">
                <i class="fas fa-user-graduate"></i>
                Lớp 3
            </button>
            <button class="grade-button" data-grade="lop4">
                <i class="fas fa-user-graduate"></i>
                Lớp 4
            </button>
            <button class="grade-button" data-grade="lop5">
                <i class="fas fa-user-graduate"></i>
                Lớp 5
            </button>
        </div>
    </div>

    <!-- Subject Selection Screen -->
    <div id="subjectScreen">
        <button class="btn btn-secondary back-button" onclick="window.backToGrades()">
            <i class="fas fa-arrow-left"></i> Quay lại chọn lớp
        </button>
        <h1 id="subjectScreenTitle">Chọn môn học</h1>
        <div class="subject-buttons" id="subjectButtonsContainer">
            <!-- Subjects will be loaded here dynamically -->
        </div>
    </div>

    <!-- Chapter Selection Screen -->
    <div id="chapterScreen">
        <button class="btn btn-secondary back-button" onclick="window.backToSubjects()">
            <i class="fas fa-arrow-left"></i> Quay lại môn học
        </button>
        <nav aria-label="breadcrumb" class="breadcrumb">
            <ol class="breadcrumb" id="breadcrumb">
                <!-- Breadcrumb will be loaded here dynamically -->
            </ol>
        </nav>
        <h2 id="chapterScreenTitle">Chọn chương</h2>
        <div class="chapter-list" id="chapterList">
            <!-- Chapters will be loaded here dynamically -->
        </div>
    </div>

    <!-- Chatbot Screen -->
    <div id="chatbot-container">
        <button class="btn btn-secondary back-button" onclick="window.backToChapters()">
            <i class="fas fa-arrow-left"></i> Quay lại chọn chương
        </button>
        <div class="chat-area">
            <div id="khung-tro-chuyen">
            </div>
            <div id="khu-vuc-nhap">
                <div id="o-nhap-tin-nhan-container">
                    <textarea id="o-nhap-tin-nhan" placeholder="Hỏi tôi điều gì đó..." rows="1"></textarea>
                    <div id="o-nhap-tin-nhan-preview"></div>
                </div>
                <button id="nut-gui">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyhGASygL5BVBB-0pJJNwoyTZ61pAzP7c",
            authDomain: "tieuhoc-a7f57.firebaseapp.com",
            projectId: "tieuhoc-a7f57",
            storageBucket: "tieuhoc-a7f57.appspot.com",
            messagingSenderId: "736631398515",
            appId: "1:736631398515:web:a41bbabeeb98c3df42ca06"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Gemini AI configuration
        const KHOA_API = "AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM"; 
        const moHinhAI = new GoogleGenerativeAI(KHOA_API);
        const moHinh = moHinhAI.getGenerativeModel({ model: "gemini-2.0-flash-thinking-exp-01-21" });

        // DOM elements
        const gradeScreen = document.getElementById('gradeScreen');
        const subjectScreen = document.getElementById('subjectScreen');
        const chapterScreen = document.getElementById('chapterScreen');
        const chatbotContainer = document.getElementById('chatbot-container');
        const khungTroChuyen = document.getElementById('khung-tro-chuyen');
        const oNhapTinNhan = document.getElementById('o-nhap-tin-nhan');
        const oNhapTinNhanPreview = document.getElementById('o-nhap-tin-nhan-preview');
        const nutGui = document.getElementById('nut-gui');
        const subjectButtonsContainer = document.getElementById('subjectButtonsContainer');
        const chapterList = document.getElementById('chapterList');
        const breadcrumb = document.getElementById('breadcrumb');
        const subjectScreenTitle = document.getElementById('subjectScreenTitle');
        const chapterScreenTitle = document.getElementById('chapterScreenTitle');
        const gradeButtons = document.querySelectorAll('.grade-button');

        // Global variables
        let currentGrade = '';
        let currentSubject = '';
        let currentChapterId = '';
        let currentChapterName = '';
        let currentExercises = [];
        let currentQuiz = null;
        let quizSubject = '';

        // Subjects by grade
        const subjectsByGrade = {
            'lop1': ['Toán', 'Tiếng Việt', 'Tự nhiên và Xã hội'],
            'lop2': ['Toán', 'Tiếng Việt', 'Tự nhiên và Xã hội'],
            'lop3': ['Toán', 'Tiếng Việt', 'Tự nhiên và Xã hội', 'Tiếng Anh'],
            'lop4': ['Toán', 'Tiếng Việt', 'Khoa học', 'Lịch sử & Địa lý', 'Tiếng Anh'],
            'lop5': ['Toán', 'Tiếng Việt', 'Khoa học', 'Lịch sử & Địa lý', 'Tiếng Anh']
        };

        // Grade names
        const gradeNames = {
            'lop1': '1',
            'lop2': '2',
            'lop3': '3',
            'lop4': '4',
            'lop5': '5'
        };

        // Subject filters for AI responses
        const subjectFilters = {
            "toan": {
                name: "Toán",
                excludeKeywords: ["đại số tuyến tính", "giải tích", "lượng tử", "phân tích chuyên sâu"],
                homeworkExamples: []
            },
            "tieng-viet": {
                name: "Tiếng Việt",
                excludeKeywords: ["nghiên cứu văn học", "phân tích chuyên sâu", "triết học", "ngữ pháp nâng cao", "phản biện văn học"],
                homeworkExamples: []
            },
            "tieng-anh": {
                name: "Tiếng Anh",
                excludeKeywords: ["advanced grammar", "literary analysis", "linguistics", "academic writing", "syntax"],
                homeworkExamples: []
            },
            "tin-hoc": {
                name: "Tin Học",
                excludeKeywords: ["lập trình", "trí tuệ nhân tạo", "máy học", "công nghệ thông tin chuyên sâu", "thuật toán phức tạp", "mạng máy tính"],
                homeworkExamples: []
            },
            "cong-nghe": {
                name: "Công Nghệ",
                excludeKeywords: ["kỹ thuật", "công nghệ cao", "tự động hóa", "robotics", "thiết kế mạch", "vật liệu mới"],
                homeworkExamples: []
            },
            "lich-su-dia-ly": {
                name: "Lịch Sử & Địa Lý",
                excludeKeywords: ["nghiên cứu sử học", "phân tích địa chính trị", "kinh tế học", "xã hội học", "diễn biến phức tạp", "lý thuyết địa lý"],
                homeworkExamples: []
            },
            "khoa-hoc": {
                name: "Khoa Học",
                excludeKeywords: ["vật lý lượng tử", "hóa học hữu cơ", "sinh học phân tử", "thiên văn học", "di truyền học", "nghiên cứu khoa học chuyên sâu"],
                homeworkExamples: []
            }
        };

        const generalExcludeKeywords = [
            "đại học", "cao học", "nghiên cứu", "phân tích chuyên sâu", "vật lý hạt nhân", "triết học",
            "kinh tế vĩ mô", "chính trị quốc tế", "chứng minh", "phản biện", "tôn giáo", "đức tin"
        ];
        
        // Homework request phrases
        const homeworkRequestPhrases = /(cho (tôi|em) bài tập|xin bài tập|gợi ý bài tập|bài tập về)/;

        // Initialize the app
        function initApp() {
            // Add event listeners to grade buttons
            gradeButtons.forEach(button => {
                button.addEventListener('click', () => selectGrade(button.dataset.grade));
            });

            // Add event listener to send button
            nutGui.addEventListener('click', guiTinNhan);
            
            // Add event listener for Enter key in message input
            oNhapTinNhan.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    guiTinNhan();
                }
            });

            // Update input preview when typing
            oNhapTinNhan.addEventListener('input', function() {
                updateInputPreview();
                adjustTextareaHeight();
            });

            // Make functions available globally for button onclick events
            window.backToGrades = backToGrades;
            window.backToSubjects = backToSubjects;
            window.backToChapters = backToChapters;
        }

        // Adjust textarea height based on content
        function adjustTextareaHeight() {
            oNhapTinNhan.style.height = 'auto';
            oNhapTinNhan.style.height = (oNhapTinNhan.scrollHeight) + 'px';
            oNhapTinNhanPreview.style.height = oNhapTinNhan.style.height;
        }

        // Update input preview
        function updateInputPreview() {
            const text = oNhapTinNhan.value;
            oNhapTinNhanPreview.innerHTML = formatFractionsAndMixedNumbers(escapeHtml(text));
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Format fractions and mixed numbers in text
        function formatFractionsAndMixedNumbers(text) {
            // Process mixed numbers first: format number(fraction) or number (fraction)
            const mixedNumberRegex = /(\d+)(?:\s|)(\()(\d+)\/(\d+)(\))/g;
            let processedText = text.replace(mixedNumberRegex, (match, whole, p1, numerator, denominator, p2) => {
                return `<span class="mixed-number"><span class="whole-part">${whole}</span><span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span></span>`;
            });
            
            // Process simple fractions: number/number
            const fractionRegex = /([^\/\s]+)\/([^\/\s]+)/g;
            processedText = processedText.replace(fractionRegex, (match, numerator, denominator) => {
                // Check if it's already processed as mixed number
                if (processedText.includes(`<span class="mixed-number"><span class="whole-part">`)) {
                    return match;
                }
                return `<span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span>`;
            });
            
            return processedText;
        }

        // Select grade
        function selectGrade(grade) {
            currentGrade = grade;
            gradeScreen.style.display = 'none';
            subjectScreen.style.display = 'flex';
            
            // Update breadcrumb
            updateBreadcrumb();
            
            // Load subjects for the selected grade
            loadSubjects();
        }

        // Back to grade selection
        function backToGrades() {
            currentGrade = '';
            currentSubject = '';
            currentChapterId = '';
            currentChapterName = '';
            
            gradeScreen.style.display = 'flex';
            subjectScreen.style.display = 'none';
            chapterScreen.style.display = 'none';
            chatbotContainer.style.display = 'none';
            
            // Clear breadcrumb
            breadcrumb.innerHTML = '';
        }

        // Load subjects for the selected grade
        function loadSubjects() {
            subjectButtonsContainer.innerHTML = '';
            const subjects = subjectsByGrade[currentGrade];
            
            subjects.forEach(subject => {
                const button = document.createElement('button');
                button.className = 'subject-button';
                button.dataset.subject = subject.toLowerCase().replace(/ /g, '-').replace(/&/g, '-');
                
                // Set icon based on subject
                let iconClass = 'fa-book';
                if (subject.includes('Toán')) iconClass = 'fa-calculator';
                else if (subject.includes('Tiếng Anh')) iconClass = 'fa-globe';
                else if (subject.includes('Tin Học')) iconClass = 'fa-laptop-code';
                else if (subject.includes('Công Nghệ')) iconClass = 'fa-tools';
                else if (subject.includes('Lịch sử') || subject.includes('Địa lý')) iconClass = 'fa-map-marked-alt';
                else if (subject.includes('Khoa học')) iconClass = 'fa-flask';
                else if (subject.includes('Tự nhiên')) iconClass = 'fa-leaf';
                
                button.innerHTML = `
                    <i class="fas ${iconClass}"></i>
                    ${subject}
                `;
                
                button.addEventListener('click', () => selectSubject(subject));
                subjectButtonsContainer.appendChild(button);
            });
            
            subjectScreenTitle.textContent = `Lớp ${gradeNames[currentGrade]} - Chọn môn học`;
        }

        // Select subject
        function selectSubject(subject) {
            currentSubject = subject;
            subjectScreen.style.display = 'none';
            chapterScreen.style.display = 'flex';
            
            // Update breadcrumb
            updateBreadcrumb();
            
            // Load chapters for the selected subject
            loadChapters();
        }

        // Back to subject selection
        function backToSubjects() {
            currentSubject = '';
            currentChapterId = '';
            currentChapterName = '';
            
            subjectScreen.style.display = 'flex';
            chapterScreen.style.display = 'none';
            chatbotContainer.style.display = 'none';
            
            // Update breadcrumb
            updateBreadcrumb();
        }

        // Load chapters for the selected subject
        async function loadChapters() {
            chapterList.innerHTML = '<div class="text-center py-3">Đang tải danh sách chương...</div>';
            chapterScreenTitle.textContent = `Môn ${currentSubject} - Chọn chương`;

            try {
                const snapshot = await db.collection('grades').doc(currentGrade)
                    .collection('subjects').doc(currentSubject)
                    .collection('chapters').orderBy('createdAt').get();
                
                if (snapshot.empty) {
                    chapterList.innerHTML = '<div class="text-center py-3">Chưa có chương nào</div>';
                    return;
                }

                chapterList.innerHTML = '';
                snapshot.forEach(doc => {
                    const chapter = doc.data();
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'chapter-card';
                    chapterItem.innerHTML = `
                        <h3>${chapter.name}</h3>
                        <p>Nhấn để xem bài tập</p>
                    `;
                    chapterItem.addEventListener('click', () => selectChapter(doc.id, chapter.name));
                    chapterList.appendChild(chapterItem);
                });
            } catch (error) {
                console.error('Lỗi khi tải chương:', error);
                chapterList.innerHTML = '<div class="text-center py-3 text-danger">Lỗi khi tải danh sách chương</div>';
            }
        }

        // Select chapter
        async function selectChapter(chapterId, chapterName) {
            currentChapterId = chapterId;
            currentChapterName = chapterName;
            chapterScreen.style.display = 'none';
            chatbotContainer.style.display = 'flex';
            
            // Update breadcrumb
            updateBreadcrumb();
            
            // Load exercises for the selected chapter
            await loadExercises();
            
            // Show welcome message
            khungTroChuyen.innerHTML = '';
            themTinNhanVaoGiaoDien("bot", `Chào mừng em đến với chương "${chapterName}" của môn ${currentSubject}! Tôi có thể giúp gì cho em?`);
        }

        // Back to chapter selection
        function backToChapters() {
            currentChapterId = '';
            currentChapterName = '';
            
            chapterScreen.style.display = 'flex';
            chatbotContainer.style.display = 'none';
            
            // Update breadcrumb
            updateBreadcrumb();
        }

        // Load exercises for the selected chapter
        async function loadExercises() {
            currentExercises = [];
            
            try {
                const snapshot = await db.collection('grades').doc(currentGrade)
                    .collection('subjects').doc(currentSubject)
                    .collection('chapters').doc(currentChapterId)
                    .collection('exercises').orderBy('createdAt').get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        currentExercises.push({
                            id: doc.id,
                            question: doc.data().question
                        });
                    });
                }
                
                // Update subject filters with loaded exercises
                const subjectKey = currentSubject.toLowerCase().replace(/ /g, '-').replace(/&/g, '-');
                if (subjectFilters[subjectKey]) {
                    subjectFilters[subjectKey].homeworkExamples = currentExercises.map(ex => ex.question);
                }
            } catch (error) {
                console.error('Lỗi khi tải bài tập:', error);
            }
        }

        // Update breadcrumb navigation
        function updateBreadcrumb() {
            breadcrumb.innerHTML = '';
            
            // Add grade
            if (currentGrade) {
                const gradeItem = document.createElement('li');
                gradeItem.className = 'breadcrumb-item';
                gradeItem.innerHTML = `<a href="#" onclick="window.backToGrades()">${gradeNames[currentGrade]}</a>`;
                breadcrumb.appendChild(gradeItem);
            }
            
            // Add subject
            if (currentSubject) {
                const subjectItem = document.createElement('li');
                subjectItem.className = 'breadcrumb-item';
                subjectItem.innerHTML = `<a href="#" onclick="window.backToSubjects()">${currentSubject}</a>`;
                breadcrumb.appendChild(subjectItem);
            }
            
            // Add chapter
            if (currentChapterName) {
                const chapterItem = document.createElement('li');
                chapterItem.className = 'breadcrumb-item active';
                chapterItem.textContent = currentChapterName;
                breadcrumb.appendChild(chapterItem);
            }
        }

        // Add message to chat interface
        function themTinNhanVaoGiaoDien(nguoiGui, vanBan) {
            const divTinNhan = document.createElement('div');
            divTinNhan.classList.add('tin-nhan', `tin-nhan-${nguoiGui}`);

            // Format fractions and mixed numbers before processing markdown
            let processedText = formatFractionsAndMixedNumbers(vanBan);
            
            // Convert basic markdown (bold, line breaks)
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processedText = processedText.replace(/\n/g, '<br>');

            divTinNhan.innerHTML = processedText;
            khungTroChuyen.appendChild(divTinNhan);
            // Scroll to bottom of chat
            khungTroChuyen.scrollTop = khungTroChuyen.scrollHeight;
        }

        // Start multiple choice quiz
        function startMultipleChoiceQuiz(subject) {
            if (!currentExercises || currentExercises.length === 0) {
                themTinNhanVaoGiaoDien("bot", `Hiện không có bài tập trắc nghiệm nào cho chương này.`);
                return;
            }

            // Get all exercises for the current chapter
            const allQuestions = currentExercises;
            
            // If there are more than 10 questions, select 10 randomly
            const selectedQuestions = (allQuestions.length > 10) 
                ? getRandomQuestions(allQuestions, 10) 
                : allQuestions;

            quizSubject = subject;
            currentQuiz = {
                questions: selectedQuestions,
                currentQuestionIndex: 0,
                userAnswers: [],
                score: 0
            };
            
            showNextQuestion();
        }

        // Get random questions
        function getRandomQuestions(questions, count) {
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // Show next question in quiz
        function showNextQuestion() {
            if (currentQuiz.currentQuestionIndex >= currentQuiz.questions.length) {
                // End of quiz
                finishQuiz();
                return;
            }
            
            const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            let message = `Câu ${currentQuiz.currentQuestionIndex + 1}: ${question.question}\n\n`;
            message += "Hãy trả lời câu hỏi này (em có thể nhập câu trả lời của mình)";
            
            themTinNhanVaoGiaoDien("bot", message);
        }

        // Finish quiz and show results
        function finishQuiz() {
            const totalQuestions = currentQuiz.questions.length;
            const score = (currentQuiz.score / totalQuestions) * 10; // Calculate score out of 10
            
            let resultMessage = `Kết thúc bài tập!\n`;
            resultMessage += `em đã hoàn thành ${totalQuestions} câu hỏi\n`;
            resultMessage += `Số câu đúng: ${currentQuiz.score}/${totalQuestions}\n`;
            resultMessage += `Điểm của em: ${score.toFixed(1)}/10\n\n`;
            
            themTinNhanVaoGiaoDien("bot", resultMessage);
            currentQuiz = null;
            quizSubject = '';
        }

        // Handle quiz answer
        function handleQuizAnswer(answer) {
            const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            const userAnswer = answer.trim();
            
            // Store user answer
            currentQuiz.userAnswers.push(userAnswer);
            
            // For now, just count all answers as correct (since we don't have answer keys)
            currentQuiz.score++;
            themTinNhanVaoGiaoDien("bot", "Cảm ơn câu trả lời của em!");
                
            // Move to next question
            currentQuiz.currentQuestionIndex++;
            setTimeout(() => showNextQuestion(), 1500);
        }

        // Send message
        async function guiTinNhan() {
            const tinNhanNguoiDung = oNhapTinNhan.value.trim();
            if (!tinNhanNguoiDung) return;

            themTinNhanVaoGiaoDien("nguoi-dung", tinNhanNguoiDung);
            oNhapTinNhan.value = '';
            oNhapTinNhanPreview.innerHTML = '';
            adjustTextareaHeight();

            // Handle if in quiz mode
            if (currentQuiz) {
                handleQuizAnswer(tinNhanNguoiDung);
                return;
            }

            // Check for multiple choice quiz request
            const isAskingForMultipleChoice = /(bài tập trắc nghiệm|trắc nghiệm|bài tập TN)/i.test(tinNhanNguoiDung);
            if (isAskingForMultipleChoice) {
                const subjectKey = currentSubject.toLowerCase().replace(/ /g, '-').replace(/&/g, '-');
                startMultipleChoiceQuiz(subjectKey);
                return;
            }

            // Handle simple greetings
            const loiChao = ["chào", "hello", "hi"];
            if (loiChao.some(chao => tinNhanNguoiDung.toLowerCase().includes(chao))) {
                themTinNhanVaoGiaoDien("bot", `Chào em! Tôi là một chatbot AI được thiết kế để trả lời các câu hỏi cấp tiểu học cho môn ${currentSubject}, chương "${currentChapterName}". em có câu hỏi gì không?`);
                return;
            }

            // --- HOMEWORK REQUEST LOGIC ---
            const isAskingForHomework = homeworkRequestPhrases.test(tinNhanNguoiDung.toLowerCase());

            if (isAskingForHomework) {
                const subjectKey = currentSubject.toLowerCase().replace(/ /g, '-').replace(/&/g, '-');
                
                if (currentExercises && currentExercises.length > 0) {
                    let examples = currentExercises.map((e, i) => `${i + 1}. ${e.question}`).join('\n');
                    themTinNhanVaoGiaoDien("bot", `Dưới đây là một số bài tập trong chương "${currentChapterName}" môn ${currentSubject}:\n${examples}\n\nem hãy thử giải các bài tập này và hỏi tôi nếu có bất kỳ câu hỏi nào về cách làm nhé!`);
                } else {
                    themTinNhanVaoGiaoDien("bot", `Hiện không có bài tập nào trong chương "${currentChapterName}" của môn ${currentSubject}. em có thể hỏi tôi về cách làm một dạng bài tập nào đó, tôi sẽ hướng dẫn em!`);
                }
                return;
            }
            // --- END HOMEWORK REQUEST LOGIC ---

            // Check if question is appropriate for elementary level
            if (!laCauHoiTieuHoc(tinNhanNguoiDung)) {
                themTinNhanVaoGiaoDien("bot", "Xin lỗi, tôi chỉ có thể giúp em với các câu hỏi và bài tập ở cấp độ tiểu học. Vui lòng hỏi những câu hỏi phù hợp hơn nhé.");
                return;
            }

            // Send question to AI model if it's not a homework request and is appropriate
            try {
                const subjectKey = currentSubject.toLowerCase().replace(/ /g, '-').replace(/&/g, '-');
                const subjectName = subjectFilters[subjectKey]?.name || currentSubject;
                
                const loiNhac = `em là một giáo viên AI thân thiện và hữu ích (lưu ý xưng hô với người dùng là thầy - em), chuyên giải đáp các câu hỏi và gợi ý cách làm bài tập cho học sinh tiểu học trong môn ${subjectName}, chương "${currentChapterName}". Hãy trả lời một cách đơn giản, dễ hiểu, và chỉ tập trung vào kiến thức cấp tiểu học. Tuyệt đối không giải bài tập cụ thể, chỉ gợi ý phương pháp hoặc hướng dẫn. Nếu câu hỏi không phù hợp cấp tiểu học hoặc yêu cầu giải bài tập chi tiết, hãy từ chối một cách nhẹ nhàng và lịch sự. Nếu người dùng xin bài tập để làm thì cũng có thể được.
                \n\nCâu hỏi: ${tinNhanNguoiDung}`;

                const ketQua = await moHinh.generateContent(loiNhac);
                const phanHoi = await ketQua.response;
                const traLoiBot = phanHoi.text();
                themTinNhanVaoGiaoDien("bot", traLoiBot);

            } catch (loi) {
                console.error("Lỗi khi gọi API Gemini: ", loi);
                themTinNhanVaoGiaoDien("bot", "Rất tiếc, có lỗi xảy ra. Vui lòng thử lại sau nhé!");
            }
        }

        /**
         * Check if a question is appropriate for elementary level.
         * @param {string} cauHoi - User's question.
         * @returns {boolean} - True if appropriate, False if not.
         */
        function laCauHoiTieuHoc(cauHoi) {
            const cauHoiThuong = cauHoi.toLowerCase();

            // Check general exclude keywords
            const laKhongTieuHocChung = generalExcludeKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
            if (laKhongTieuHocChung) return false;

            // Check subject-specific exclude keywords
            const subjectKey = currentSubject.toLowerCase().replace(/ /g, '-').replace(/&/g, '-');
            if (subjectFilters[subjectKey]) {
                const subjectSpecificKeywords = subjectFilters[subjectKey].excludeKeywords;
                const laKhongTieuHocMonHoc = subjectSpecificKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
                if (laKhongTieuHocMonHoc) return false;
            }

            return true;
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
